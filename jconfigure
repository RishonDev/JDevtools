#!/bin/bash
# jconfigure - Configuration tool for JDevtools
# Sets up and configures the Maven wrapper and project settings

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# Function to print colored messages
print_info() {
    echo -e "${GREEN}[jconfigure]${NC} $1"
}

print_error() {
    echo -e "${RED}[jconfigure]${NC} $1" >&2
}

print_warning() {
    echo -e "${YELLOW}[jconfigure]${NC} $1"
}

print_section() {
    echo -e "${BLUE}[jconfigure]${NC} $1"
}

# Function to check if Java is installed
check_java() {
    if command -v java &> /dev/null; then
        JAVA_VERSION=$(java -version 2>&1 | awk -F '"' '/version/ {print $2}')
        print_info "Java detected: $JAVA_VERSION"
        return 0
    else
        print_error "Java not found. Please install Java 11 or higher."
        return 1
    fi
}

# Function to verify Maven wrapper
check_maven_wrapper() {
    if [ -f "$SCRIPT_DIR/mvnw" ]; then
        print_info "Maven wrapper found"
        return 0
    else
        print_warning "Maven wrapper not found"
        return 1
    fi
}

# Function to test Maven wrapper
test_maven_wrapper() {
    print_info "Testing Maven wrapper..."
    if "$SCRIPT_DIR/mvnw" --version &> /dev/null; then
        print_info "Maven wrapper is working correctly"
        "$SCRIPT_DIR/mvnw" --version
        return 0
    else
        print_error "Maven wrapper test failed"
        return 1
    fi
}

# Function to display configuration
show_config() {
    print_section "=== JDevtools Configuration ==="
    echo ""
    print_info "Available tools:"
    echo "  - jcompile         : Compile Java code"
    echo "  - jcompile-dispatch: Parallel compilation dispatcher"
    echo "  - jtest            : Run tests"
    echo "  - jconfigure       : Configuration tool (this script)"
    echo ""
    
    if [ -f "$SCRIPT_DIR/pom.xml" ]; then
        print_info "Project configuration (pom.xml) found"
        
        # Extract basic info from pom.xml
        if command -v xmllint &> /dev/null; then
            GROUP_ID=$(xmllint --xpath "//*[local-name()='groupId']/text()" "$SCRIPT_DIR/pom.xml" 2>/dev/null | head -1)
            ARTIFACT_ID=$(xmllint --xpath "//*[local-name()='artifactId']/text()" "$SCRIPT_DIR/pom.xml" 2>/dev/null | head -1)
            VERSION=$(xmllint --xpath "//*[local-name()='version']/text()" "$SCRIPT_DIR/pom.xml" 2>/dev/null | head -1)
            
            echo "  Group ID    : $GROUP_ID"
            echo "  Artifact ID : $ARTIFACT_ID"
            echo "  Version     : $VERSION"
        fi
    else
        print_warning "No pom.xml found in current directory"
    fi
    echo ""
}

# Main function
main() {
    print_section "=== JDevtools Configuration Tool ==="
    echo ""
    
    # Parse arguments
    case "${1:-}" in
        --check|check)
            print_info "Checking configuration..."
            check_java || exit 1
            check_maven_wrapper || exit 1
            test_maven_wrapper || exit 1
            show_config
            print_info "Configuration check completed!"
            ;;
        --test|test)
            print_info "Testing Maven wrapper..."
            test_maven_wrapper || exit 1
            ;;
        --show|show|--info|info)
            show_config
            ;;
        -h|--help|help)
            echo "Usage: jconfigure [COMMAND]"
            echo ""
            echo "Commands:"
            echo "  check       Check and verify configuration"
            echo "  test        Test Maven wrapper"
            echo "  show        Show current configuration"
            echo "  help        Display this help message"
            echo ""
            echo "If no command is provided, 'check' is used by default."
            ;;
        "")
            # Default action: check everything
            print_info "Running configuration check..."
            check_java || exit 1
            check_maven_wrapper || exit 1
            test_maven_wrapper || exit 1
            show_config
            print_info "Configuration completed successfully!"
            ;;
        *)
            print_error "Unknown command: $1"
            print_info "Use 'jconfigure --help' for usage information"
            exit 1
            ;;
    esac
}

main "$@"
